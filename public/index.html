<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat App</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <audio id="messageSound" src="ping.mp3" preload="auto"></audio>

    <div id="sidebar">
        <div id="sidebarHeader">
            <h2>Channels</h2>
            <button id="toggleSidebar"><i class="fas fa-bars"></i></button>
        </div>
        <ul id="channelList">
            <li id="textChatButton" class="sidebarButton"><i class="fas fa-comment-alt"></i> Text Chat</li>
        </ul>
        <div id="sidebarFooter">
            <p>12Tae12 Software. Https://1t2.pages.dev</p>
        </div>
    </div>

    <div id="messages">
        <ul id="messagesList"></ul>
        <div id="inputContainer">
            <form id="messageForm">
                <input type="text" id="nameInput" placeholder="Enter your username" autocomplete="off">
                <input type="text" id="messageInput" placeholder="Message" autocomplete="off">
                <button type="submit"><i class="fas fa-paper-plane"></i> Send</button>
            </form>
            <form id="fileForm" enctype="multipart/form-data">
                <input type="file" id="fileInput" name="file">
                <button type="submit" id="fileButton"><i class="fas fa-file-upload"></i> Send File</button>
            </form>
        </div>
    </div>

    <select id="threadSelect">
        <option value="" disabled selected>Select a thread</option>
    </select>

    <script src="https://cdn.socket.io/4.3.1/socket.io.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const socket = io();
            const messages = document.getElementById('messages');
            const messagesList = document.getElementById('messagesList');
            const inputContainer = document.getElementById('inputContainer');
            const messageForm = document.getElementById('messageForm');
            const nameInput = document.getElementById('nameInput');
            const messageInput = document.getElementById('messageInput');
            const fileForm = document.getElementById('fileForm');
            const fileInput = document.getElementById('fileInput');
            const fileButton = document.getElementById('fileButton');
            const messageSound = document.getElementById('messageSound');
            const threadSelect = document.getElementById('threadSelect');

            let username = localStorage.getItem('username');
            let currentThread = null;

            if (!username) {
                const userPrompt = prompt("Enter your desired username:");
                if (userPrompt && userPrompt.trim() !== '') {
                    username = userPrompt.trim();
                    localStorage.setItem('username', username);
                } else {
                    username = 'Anonymous';
                }
            }

            nameInput.value = username;

            // Fetch available threads
            fetch('/threads')
                .then(response => response.json())
                .then(data => {
                    data.threads.forEach(thread => {
                        const option = document.createElement('option');
                        option.value = thread.name;
                        option.textContent = thread.name;
                        threadSelect.appendChild(option);
                    });
                });

            // Handle thread selection
            threadSelect.addEventListener('change', function() {
                const selectedThread = threadSelect.value;
                socket.emit('join thread', { username, threadName: selectedThread });
            });

            socket.on('joined thread', function(threadName) {
                currentThread = threadName;
                messagesList.innerHTML = ''; // Clear messages
            });

            socket.on('error', function(errorMessage) {
                alert(errorMessage);
            });

            messageForm.addEventListener('submit', function(e) {
                e.preventDefault();
                if (messageInput.value.trim() && currentThread) {
                    const msg = messageInput.value.trim();
                    const formattedMsg = username + ': ' + msg;
                    socket.emit('chat message', { threadName: currentThread, message: formattedMsg });
                    messageInput.value = '';
                }
            });

            fileForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const file = fileInput.files[0];
                if (file && currentThread) {
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('username', username);
                    formData.append('threadName', currentThread);

                    fetch('/upload', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.text())
                    .then(data => {
                        console.log(data);
                        fileInput.value = ''; // Clear the file input
                    })
                    .catch(error => {
                        console.error('Error uploading file:', error);
                    });
                }
            });

            function playMessageSound() {
                messageSound.play();
            }

            socket.on('chat message', function(msg) {
                const item = document.createElement('li');
                item.textContent = msg;
                messagesList.appendChild(item);
                scrollToBottom();
                playMessageSound();
            });

            function scrollToBottom() {
                messages.scrollTop = messages.scrollHeight;
            }

            window.addEventListener('scroll', function() {
                const scrolledToBottom = isScrolledToBottom();
                if (scrolledToBottom) {
                    inputContainer.classList.add('fixed');
                } else {
                    inputContainer.classList.remove('fixed');
                }
            });

            function isScrolledToBottom() {
                return messages.scrollHeight - messages.clientHeight <= messages.scrollTop + 1;
            }

            socket.on('new notification', (notification) => {
                displayNotification(notification);
            });

            function displayNotification(notification) {
                const notificationElement = document.createElement('div');
                notificationElement.className = 'notification';
                notificationElement.innerText = notification.message;
                document.body.appendChild(notificationElement);
                setTimeout(() => {
                    notificationElement.remove();
                }, 5000);
            }
        });

        document.getElementById('userProfileForm').addEventListener('submit', async (event) => {
            event.preventDefault();
            const formData = new FormData(event.target);
            const username = formData.get('username');
            const email = formData.get('email');
            await addUserProfile(username, email);
        });

        async function addUserProfile(username, email) {
            const response = await fetch('/users', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ username, email })
            });
            if (response.ok) {
                document.cookie = `username=${username}; path=/`;
                document.cookie = `email=${email}; path=/`;
                alert('User profile added successfully');
            } else {
                alert('Failed to add user profile');
            }
        }

        async function getUserProfiles() {
            const response = await fetch('/users');
            const users = await response.json();
            console.log(users);
        }
    </script>
</body>
</html>
